<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LABIIZ   Almac√©n</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

    <!-- XLSX (para exportar Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lab-purple': 'rgb(149,47,87)',
                        'lab-light-purple': '#952f57',
                        'lab-table': 'rgb(255,255,255)'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 min-h-screen">
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg">
        <div class="p-6 border-b">
            <div class="text-center">
                <h1 class="text-6xl font-bold text-gray-800">LABIIZ</h1>
                <p class="text-gray-500">UPIIZ-IPN</p>
                <div class="flex justify-center mt-2">
                    <img src="{{ url_for('static', filename='ingalim.png') }}" alt="Logo grande LABIIZ" class="w-24 h-24 object-contain">
                </div>
            </div>
        </div>
        <nav class="mt-6">
            <div class="px-4 space-y-2">
                <a href="/dashboard" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-home"></i><span>Inicio</span>
                </a>
                <a href="/almacen" class="flex items-center space-x-3 px-4 py-3 bg-lab-purple text-white rounded-lg">
                    <i class="fas fa-boxes"></i><span>Almac√©n</span>
                </a>
                <a href="/citas" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-vial"></i><span>Citas de laboratorio</span>
                </a>
                <a href="/inventario" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-chart-bar"></i><span>Inventario</span>
                </a>
                <a href="/tickets" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-ticket-alt"></i><span>Vales de laboratorio</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 overflow-hidden">
        <header class="bg-lab-purple text-white px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-semibold">Almac√©n</h2>
            <div class="flex items-center space-x-4">
                <span class="text-sm">Nombre de usuario</span>
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-lab-purple"></i>
                </div>
            </div>
        </header>

        <div class="p-8 space-y-8">
            <!-- Buscador y bot√≥n agregar -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Buscar producto" class="pl-10 pr-4 py-2 border border-gray-300 rounded-full w-80 focus:outline-none focus:ring-2 focus:ring-lab-purple">
                </div>
                <button id="openModalBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>A√±adir nuevo material
                </button>
                <button id="downloadExcelBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Descargar Excel
                </button>
            </div>

            <!-- Total productos -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <h3 class="text-sm font-medium text-gray-600">Total de productos</h3>
                <p class="text-2xl font-bold text-gray-800" id="totalProductos">0</p>
            </div>

           <!-- Tabla con scroll interno -->
<div class="bg-white rounded-lg shadow-lg mb-8">
                <div class="w-full overflow-x-auto">
        <!-- Contenedor con altura fija y scroll vertical -->
        <div class="max-h-[450px] overflow-y-auto">
            <table class="table-fixed w-full text-sm">
                <thead class="bg-lab-table text-black sticky top-0 z-10">
                    <tr>
                        <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Producto</th>
                        <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">C√≥digo de Barras</th>
                        <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Tipo / Color</th>
                        <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for p in productos %}
                    <tr class="odd:bg-gray-50 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900 truncate">{{ p.nombre }}</td>
                        <td class="px-6 py-4 font-mono truncate">{{ p.codigo_barras }}</td>
                        <td class="px-6 py-4">{{ p.tipo }}{% if p.color %} / {{ p.color }}{% endif %}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="text-red-600 hover:text-red-800 eliminar-btn" data-id="{{ p.codigo_barras }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

            
        </div>
       <!-- üîΩ MODAL PARA A√ëADIR NUEVO MATERIAL üîΩ -->
<div id="addMaterialModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div id="overlay" class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-lab-purple text-white rounded-lg shadow-2xl w-[90%] max-w-xl p-6 flex flex-col">
        <button id="closeModalBtn" class="absolute top-4 right-4 text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        <h3 class="text-2xl font-semibold mb-4 text-center">A√±adir nuevo material</h3>

        <form id="materialForm" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                <label for="photoInput" class="group relative flex items-center justify-center bg-white/20 rounded-lg h-32 cursor-pointer overflow-hidden">
                    <i id="photoPlaceholder" class="far fa-image text-4xl text-white/60 group-hover:text-white"></i>
                    <img id="photoPreview" alt="preview" class="absolute inset-0 w-full h-full object-cover hidden" />
                    <input id="photoInput" type="file" accept="image/*" class="hidden">
                    <span class="absolute bottom-1 right-1 text-xs bg-black/50 px-2 rounded">Cambiar foto</span>
                </label>
                <div class="flex flex-col gap-4">
                    <select id="tipoSelect" required class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white">
                        <option value="" disabled selected>Selecciona tipo</option>
                        <option value="material">Material</option>
                        <option value="reactivo">Reactivo</option>
                    </select>
                    <div id="colorContainer" class="hidden">
                        <select id="colorSelect" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="" disabled selected>Selecciona color</option>
                            <option value="rojo">Rojo</option>
                            <option value="blanco">Blanco</option>
                            <option value="azul">Azul</option>
                            <option value="amarillo">Amarillo</option>
                            <option value="verde">Verde</option>
                            <option value="cafe">Caf√©</option>
                        </select>
                    </div>
                    <textarea id="nombreInput" placeholder="Nombre del producto" class="w-full px-4 py-2 rounded-lg text-black h-24 focus:outline-none focus:ring-2 focus:ring-white"></textarea>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input id="cantidadInput" type="number" placeholder="Agregar cantidad" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
                <input id="localizacionInput" type="text" placeholder="Localizaci√≥n" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
                <input id="capacidadInput" type="text" placeholder="Capacidad" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
                <div class="flex flex-col">
                    <label for="fechaIngreso" class="text-white text-sm mb-1">Fecha de ingreso</label>
                    <input type="date" id="fechaIngreso" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
                </div>
                <div class="flex flex-col" id="fechaCaducidadContainer" style="display:none;">
                    <label for="fechaCaducidad" class="text-white text-sm mb-1">Fecha de caducidad</label>
                    <input type="date" id="fechaCaducidad" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
                </div>
                <input id="observacionesInput" type="text" placeholder="Observaciones" class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-white" />
            </div>

            <div class="mt-4 flex flex-col sm:flex-row sm:justify-end gap-4">
                <button type="button" id="cancelModalBtn" class="px-6 py-3 bg-yellow-400/90 hover:bg-yellow-400 text-black rounded-lg">Cancelar</button>
                <button type="submit" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg">Agregar</button>
            </div>
        </form>
    </div>
</div>
<!-- üîº FIN MODAL üîº -->


    </main>
</div>

<!-- ========== SCRIPT ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ELEMENTOS principales
    const fileInput = document.getElementById('photoInput');
    const imgPreview = document.getElementById('photoPreview');
    const placeholder = document.getElementById('photoPlaceholder');

    const openBtn = document.getElementById('openModalBtn');
    const modal = document.getElementById('addMaterialModal');
    const overlay = document.getElementById('overlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const closeBtns = [closeModalBtn, cancelModalBtn, overlay];

    const form = document.getElementById('materialForm');
    const tipoSelect = document.getElementById('tipoSelect');
    const colorContainer = document.getElementById('colorContainer');
    const colorSelect = document.getElementById('colorSelect');
    const fechaCaducidad = document.getElementById('fechaCaducidad');
    const fechaCaducidadContainer = document.getElementById('fechaCaducidadContainer');

    const nombreInput = document.getElementById('nombreInput');
    const cantidadInput = document.getElementById('cantidadInput');
    const localizacionInput = document.getElementById('localizacionInput');
    const capacidadInput = document.getElementById('capacidadInput');
    const fechaIngreso = document.getElementById('fechaIngreso');
    const observacionesInput = document.getElementById('observacionesInput');

    const tbody = document.querySelector('tbody');
    const totalProductos = document.getElementById('totalProductos');
    const searchInput = document.getElementById('searchInput');
    const downloadBtn = document.getElementById('downloadExcelBtn');

    // Contenedor para notificaciones
    const notiContainer = document.createElement('div');
    notiContainer.className = 'fixed top-6 right-6 z-50 space-y-2';
    document.body.appendChild(notiContainer);

    const mostrarNotificacion = (mensaje, tipo = 'green') => {
        const noti = document.createElement('div');
        // uso de clases simples para no depender de utilidades inexistentes
        noti.style.padding = '0.6rem 1rem';
        noti.style.borderRadius = '0.5rem';
        noti.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';
        noti.style.color = 'white';
        noti.style.backgroundColor = (tipo === 'green') ? '#16a34a' : '#dc2626';
        noti.style.opacity = '1';
        noti.style.transition = 'opacity 0.5s';
        noti.textContent = mensaje;
        notiContainer.appendChild(noti);
        setTimeout(() => {
            noti.style.opacity = '0';
            setTimeout(() => noti.remove(), 500);
        }, 2000);
    };

    // Animaci√≥n CSS peque√±a (opcional)
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fade-in { from { opacity: 0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    `;
    document.head.appendChild(style);

    // Helpers de localStorage
    const guardarLocal = producto => {
        let productos = JSON.parse(localStorage.getItem('productos')) || [];
        productos.push(producto);
        localStorage.setItem('productos', JSON.stringify(productos));
    };

    const eliminarLocal = codigo => {
        let productos = JSON.parse(localStorage.getItem('productos')) || [];
        productos = productos.filter(p => p.codigo !== codigo);
        localStorage.setItem('productos', JSON.stringify(productos));
    };

    const obtenerProductosLocal = () => JSON.parse(localStorage.getItem('productos')) || [];

    // Reset y toggle modal
    const resetModal = () => {
        form.reset();
        imgPreview.src = "";
        imgPreview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        colorContainer.classList.add('hidden');
        fechaCaducidadContainer.style.display = 'none';
        colorSelect.removeAttribute('required');
        fechaCaducidad.removeAttribute('required');
    };

    const toggleModal = (open = null) => {
        // open === true -> mostrar ; false -> ocultar; null -> toggle
        if (open === true) modal.classList.remove('hidden');
        else if (open === false) modal.classList.add('hidden');
        else modal.classList.toggle('hidden');

        if (modal.classList.contains('hidden')) resetModal();
    };

    // Asignar listeners para abrir/cerrar modal (esto recupera la funcionalidad de "A√±adir")
    openBtn && openBtn.addEventListener('click', () => toggleModal(true));
    closeBtns.forEach(btn => btn && btn.addEventListener('click', () => toggleModal(false)));

    // Preview de imagen en modal
    fileInput && fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        imgPreview.src = URL.createObjectURL(file);
        imgPreview.classList.remove('hidden');
        placeholder.classList.add('hidden');
    });

    // Mostrar campos condicionales para reactivos
    tipoSelect && tipoSelect.addEventListener('change', () => {
        if (tipoSelect.value === 'reactivo') {
            colorContainer.classList.remove('hidden');
            fechaCaducidadContainer.style.display = 'flex';
            colorSelect.setAttribute('required', 'true');
            fechaCaducidad.setAttribute('required', 'true');
        } else {
            colorContainer.classList.add('hidden');
            fechaCaducidadContainer.style.display = 'none';
            colorSelect.removeAttribute('required');
            fechaCaducidad.removeAttribute('required');
        }
    });

    const generarCodigoBarras = () => Date.now().toString();

    // Render tabla
    const agregarFilaTabla = producto => {
        const tr = document.createElement('tr');
        tr.className = 'odd:bg-gray-50 hover:bg-gray-100 transition-colors animate-fade-in';
        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 truncate">${producto.nombre}</td>
            <td class="px-6 py-4 font-mono truncate">${producto.codigo}</td>
            <td class="px-6 py-4">${producto.tipo} ${producto.color ? ' / ' + producto.color : ''}</td>
            <td class="px-6 py-4 text-center">
                <button class="text-red-600 hover:text-red-800 eliminar-btn" data-codigo="${producto.codigo}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        totalProductos.textContent = tbody.children.length;
    };

    const limpiarTabla = () => {
        tbody.innerHTML = '';
        totalProductos.textContent = 0;
    };

    

    form && form.addEventListener('submit', async e => {
    e.preventDefault();

    const producto = {
        nombre: nombreInput.value.trim(),
        tipo: tipoSelect.value,
        color: colorSelect.value || null,
        cantidad: cantidadInput.value,
        localizacion: localizacionInput.value,
        capacidad: capacidadInput.value,
        fecha_ingreso: fechaIngreso.value,
        fecha_caducidad: fechaCaducidad.value || null,
        observaciones: observacionesInput.value
    };

    try {
        const response = await fetch('/almacen/agregar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(producto)
        });

        const data = await response.json();
        if (data.ok) {
            mostrarNotificacion('‚úÖ Producto agregado correctamente');
            toggleModal(false);
            location.reload(); // recarga para mostrar la nueva fila
        } else {
            mostrarNotificacion('‚ùå Error al agregar el producto', 'red');
        }
    } catch (error) {
        console.error(error);
        mostrarNotificacion('‚ö†Ô∏è Error de conexi√≥n con el servidor', 'red');
    }
});


    // Eliminar producto (delegaci√≥n)
    tbody.addEventListener('click', e => {
        const btn = e.target.closest('.eliminar-btn');
        if (!btn) return;
        const codigo = btn.dataset.codigo;
        const fila = btn.closest('tr');
        if (confirm('¬øSeguro que deseas eliminar este producto?')) {
            eliminarLocal(codigo);
            fila.remove();
            totalProductos.textContent = tbody.children.length;
            mostrarNotificacion('Producto eliminado correctamente', 'red');
        }
    });

    // B√∫squeda por nombre o c√≥digo (compatible con scanner USB que escribe en el input)
    searchInput && searchInput.addEventListener('input', () => {
        const term = searchInput.value.toLowerCase().trim();
        tbody.querySelectorAll('tr').forEach(row => {
            const nombre = row.children[0].textContent.toLowerCase();
            const codigo = row.children[1].textContent.toLowerCase();
            row.style.display = (nombre.includes(term) || codigo.includes(term)) ? '' : 'none';
        });
    });

    // Descargar Excel (usa la librer√≠a XLSX que debe estar incluida en tu <head>)
    downloadBtn && downloadBtn.addEventListener('click', () => {
        const productos = obtenerProductosLocal();
        if (!productos || productos.length === 0) {
            alert('No hay datos para exportar.');
            return;
        }

        // Preparar datos para Excel (si quieres columnas con nombres m√°s legibles, puedes mapear)
        const exportData = productos.map(p => ({
            Producto: p.nombre,
            Codigo: p.codigo,
            Tipo: p.tipo,
            Color: p.color || '',
            Cantidad: p.cantidad || '',
            Localizacion: p.localizacion || '',
            Capacidad: p.capacidad || '',
            FechaIngreso: p.fechaIngreso || '',
            FechaCaducidad: p.fechaCaducidad || '',
            Observaciones: p.observaciones || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
        XLSX.writeFile(wb, 'almacen_labiiz.xlsx');
    });

    // Inicializar tabla desde localStorage
    cargarLocal();

    // --- fin DOMContentLoaded ---
});

document.addEventListener('DOMContentLoaded', () => {
  const totalProductos = document.getElementById('totalProductos');
  totalProductos.textContent = document.querySelectorAll('tbody tr').length;
});
</script>

</body>
</html>
